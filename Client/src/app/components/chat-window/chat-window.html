@if (_chatService.currentOpenChat()) {
  <div class="position-relative d-flex flex-column h-100 w-100 bg-white rounded-3 shadow-sm overflow-hidden">

    <!-- Chat Header -->
    <div class="chat-header d-flex justify-content-between align-items-center w-100 bg-white px-4 py-3 border-bottom">
      <div class="d-flex align-items-center gap-3">
        <img
          [src]="_chatService.currentOpenChat()?.profilePicture || 'https://randomuser.me/api/portraits/lego/5.jpg'"
          alt="User Profile Picture"
          class="rounded-circle border border-2 shadow-sm"
          style="width: 50px; height: 50px; object-fit: cover;"
        >
        <div>
          <h6 class="fw-semibold mb-0 text-dark">
            {{ _chatService.currentOpenChat()?.fullName | titlecase }}
          </h6>
          <small class="text-muted">
            {{ _chatService.status(_chatService.currentOpenChat()?.userName!) }}
          </small>
        </div>
      </div>

      <div class="d-flex align-items-center gap-3">
        <mat-icon class="text-secondary" style="cursor: pointer;" title="Start Video Call">video_call</mat-icon>
        <mat-icon class="text-secondary" style="cursor: pointer;" title="View Info">info</mat-icon>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="flex-grow-1 overflow-hidden d-flex flex-column bg-light">
      <div class="flex-grow-1 overflow-auto pb-2" style="scrollbar-width: thin;">
        <app-chat-box></app-chat-box>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input border-top bg-white px-4 py-3 position-relative">

      <!-- Emoji Picker -->
      @if (showEmojiPicker) {
        <div class="emoji-picker-container">
          <emoji-mart
            (emojiSelect)="addEmoji($event)"
            set="apple"
            [perLine]="9"
            [showPreview]="true"
          ></emoji-mart>
        </div>
      }

      <div class="d-flex align-items-end gap-3 position-relative">
        <!-- Emoji Button -->
        <button
          class="btn btn-light rounded-circle d-flex align-items-center justify-content-center border shadow-sm"
          style="width: 42px; height: 42px;"
          (click)="toggleEmojiPicker()"
          title="Add Emoji"
          type="button"
        >
          <mat-icon class="text-secondary" style="font-size: 20px;">emoji_emotions</mat-icon>
        </button>

        <!-- Message Box -->
        <textarea
          [(ngModel)]="message"
          (input)="_chatService.notifyTyping()"
          (input)="autoResize($event)"
          class="form-control chat-textarea rounded-pill px-4 py-2 border-0 shadow-sm flex-grow-1"
          placeholder="Type your message..."
          (keydown)="onKeyDown($event)"
          rows="1"
          (click)="showEmojiPicker = false"
        ></textarea>


        <!-- Send Button -->
        <button
          class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
          style="width: 42px; height: 42px;"
          (click)="sendMessage()"
          type="button"
        >
          <mat-icon class="text-white" style="font-size: 20px;">send</mat-icon>
        </button>
      </div>
    </div>
  </div>
} @else {
  <div class="d-flex flex-column align-items-center bg-white justify-content-center h-100 text-center p-4 bg-light rounded-3 shadow-sm">
    <img src="openchat.png" alt="Open Chat Illustration" class="img-fluid mb-4" style="max-width: 280px; height: auto;">
    <h5 class="fw-semibold text-dark mb-1">No Chat Selected</h5>
    <p class="text-muted small mb-0">
      Choose a contact from the sidebar to start a conversation.
    </p>
  </div>
}
